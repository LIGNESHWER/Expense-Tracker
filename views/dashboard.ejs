<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | Expense Tracker</title>
  <link rel="stylesheet" href="/css/styles.css" />
  <script>
    (function () {
      try {
        var stored = localStorage.getItem('expense-tracker-theme');
        if (!stored && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          stored = 'dark';
        }
        if (stored) {
          document.documentElement.setAttribute('data-theme', stored);
        }
      } catch (error) {
        /* no-op */
      }
    }());
  </script>
</head>

<body class="dashboard-page">
  <% const safeAnalytics=analytics || {}; %>
    <% const totals=safeAnalytics.totals || { income: 0, expense: 0, savings: 0, savingsRate: 0 }; %>
      <% const todayIso=new Date().toISOString().slice(0, 10); %>
        <% const activeFormType=formData && formData.type ? formData.type : '' ; %>
          <% const incomeFormData=activeFormType==='income' ? formData : {}; %>
            <% const expenseFormData=activeFormType==='expense' ? formData : {}; %>
              <% const limitSummaries=Array.isArray(safeAnalytics.categoryLimits) ? safeAnalytics.categoryLimits : [];
                %>
                <% const limitFormState=limitFormData || {}; %>

                  <div class="dashboard-layout">
                    <!-- Sidebar -->
                    <aside class="sidebar" id="sidebar">
                      <div class="sidebar-header">
                        <h1>üí∞ Expense Tracker</h1>
                        <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar"
                          title="Toggle sidebar">
                          ‚óÄ
                        </button>
                      </div>

                      <nav class="sidebar-nav">
                        <a href="/transactions" class="active">
                          <span class="nav-icon">üìä</span>
                          <span>Dashboard</span>
                        </a>
                        <a href="/reports">
                          <span class="nav-icon">üìà</span>
                          <span>Reports</span>
                        </a>
                        <a href="/profile">
                          <span class="nav-icon">üë§</span>
                          <span>Profile</span>
                        </a>
                      </nav>

                      <div class="sidebar-footer">
                        <div class="user-info">
                          <% if (user.profilePhoto) { %>
                            <img src="<%= user.profilePhoto %>" alt="<%= user.name %>" class="user-avatar-img" />
                          <% } else { %>
                            <div class="user-avatar"><%= user.name.charAt(0).toUpperCase() %></div>
                          <% } %>
                          <div class="user-details">
                            <p class="user-name"><%= user.name %></p>
                            <p class="user-email"><%= user.email %></p>
                          </div>
                        </div>
                        <button type="button" class="theme-toggle" data-theme-toggle aria-label="Toggle theme">
                          <span id="theme-label">Theme</span>
                        </button>
                        <form action="/logout" method="POST" style="margin-top: 8px;">
                          <button type="submit" class="btn btn-secondary"
                            style="width: 100%; justify-content: center;">Logout</button>
                        </form>
                      </div>
                    </aside>

                  <!-- Overlay for mobile -->
                  <div class="sidebar-overlay" id="sidebar-overlay"></div>

                  <!-- Main Content -->
                  <main class="main-content">
                    <header class="content-header">
                      <div style="display: flex; align-items: center; gap: 12px;">
                        <button class="mobile-toggle" id="mobile-toggle" aria-label="Toggle menu">
                          <div class="hamburger">
                            <span></span>
                            <span></span>
                            <span></span>
                          </div>
                        </button>
                        <h2>Dashboard</h2>
                      </div>
                      <div class="header-actions">
                        <span style="font-size: 14px; color: var(--muted);">Welcome, <%= user.name %></span>
                      </div>
                    </header>

                    <div class="content-body">
                      <main class="dashboard-grid">
                        <section class="card summary">
                          <h2>Overview</h2>
                          <div class="summary-metrics">
                            <article>
                              <h3>Total Income</h3>
                              <p class="metric income" data-metric="income">Rs <%= Number(totals.income || 0).toFixed(2)
                                  %>
                              </p>
                            </article>
                            <article>
                              <h3>Total Expense</h3>
                              <p class="metric expense" data-metric="expense">Rs <%= Number(totals.expense ||
                                  0).toFixed(2) %>
                              </p>
                            </article>
                            <article>
                              <h3>Savings</h3>
                              <p class="metric savings" data-metric="savings">Rs <%= Number(totals.savings ||
                                  0).toFixed(2) %>
                              </p>
                            </article>
                            <article>
                              <h3>Savings Rate</h3>
                              <p class="metric" data-metric="savingsRate">
                                <%= Number(totals.savingsRate || 0).toFixed(1) %>%
                              </p>
                            </article>
                          </div>
                        </section>

                        <section class="card category-limits" data-section="category-limits">
                          <div class="card-header">
                            <h2>Category Limits</h2>
                          </div>
                          <% if (limitErrors && limitErrors.length) { %>
                            <ul class="alert">
                              <% limitErrors.forEach(function(error){ %>
                                <li>
                                  <%= error.msg %>
                                </li>
                                <% }) %>
                            </ul>
                            <% } %>
                              <form action="/category-limits" method="POST" class="form limit-form" data-limit-form
                                data-mode="<%= limitFormState && limitFormState.limitId ? 'edit' : 'create' %>">
                                <input type="hidden" name="limitId" data-field="limitId"
                                  value="<%= limitFormState && limitFormState.limitId ? limitFormState.limitId : '' %>" />

                                <label for="limit-category">Category</label>
                                <input id="limit-category" name="category" type="text" data-field="category"
                                  value="<%= limitFormState && limitFormState.category ? limitFormState.category : '' %>"
                                  placeholder="e.g. Groceries" required />

                                <label for="limit-amount">Monthly Limit (Rs)</label>
                                <input id="limit-amount" name="limit" type="number" min="0" step="0.01"
                                  data-field="limit"
                                  value="<%= limitFormState && limitFormState.limit !== undefined && limitFormState.limit !== '' ? Number(limitFormState.limit).toFixed(2) : '' %>"
                                  required />

                                <div class="limit-form-actions">
                                  <button type="submit" class="btn primary" data-role="submit-limit"
                                    data-create-label="Save Limit" data-edit-label="Update Limit">
                                    <%= limitFormState && limitFormState.limitId ? 'Update Limit' : 'Save Limit' %>
                                  </button>
                                  <button type="button"
                                    class="btn ghost <%= limitFormState && limitFormState.limitId ? '' : 'hidden' %>"
                                    data-role="cancel-limit-edit">
                                    Cancel
                                  </button>
                                </div>
                              </form>

                              <% if (!limitSummaries.length) { %>
                                <p class="empty-state">No category limits yet. Add one to track overspending.</p>
                                <% } else { %>
                                  <div class="table-wrapper">
                                    <table class="limit-table">
                                      <thead>
                                        <tr>
                                          <th>Category</th>
                                          <th class="numeric">Limit (Rs)</th>
                                          <th class="numeric">Spent (Rs)</th>
                                          <th>Status</th>
                                          <th>Actions</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        <% limitSummaries.forEach(function(limit){ %>
                                          <tr data-limit-id="<%= limit.id %>"
                                            class="<%= limit.exceeded ? 'exceeded' : '' %>">
                                            <td>
                                              <%= limit.category %>
                                            </td>
                                            <td class="numeric">
                                              <%= Number(limit.limit || 0).toFixed(2) %>
                                            </td>
                                            <td class="numeric">
                                              <%= Number(limit.spent || 0).toFixed(2) %>
                                            </td>
                                            <td>
                                              <span class="limit-status <%= limit.exceeded ? 'exceeded' : 'within' %>">
                                                <% if (limit.exceeded) { %>
                                                  Exceeded by <%= Number(limit.percentageExceeded || 0).toFixed(1) %>%
                                                    <% } else { %>
                                                      Used <%= Number(limit.percentageUsed || 0).toFixed(1) %>%
                                                        <% } %>
                                              </span>
                                            </td>
                                            <td>
                                              <div class="table-actions">
                                                <button type="button" class="btn ghost edit-limit"
                                                  data-limit-id="<%= limit.id %>" data-category="<%= limit.category %>"
                                                  data-limit="<%= Number(limit.limit || 0).toFixed(2) %>">
                                                  Edit
                                                </button>
                                                <form action="/category-limits/<%= limit.id %>?_method=DELETE"
                                                  method="POST">
                                                  <input type="hidden" name="_method" value="DELETE" />
                                                  <button type="submit" class="btn danger"
                                                    onclick="return confirm('Delete this category limit?');">
                                                    Delete
                                                  </button>
                                                </form>
                                              </div>
                                            </td>
                                          </tr>
                                          <% }) %>
                                      </tbody>
                                    </table>
                                  </div>
                                  <% } %>
                        </section>

                        <section class="card transaction-form" data-section="income">
                          <div class="form-header">
                            <h2 data-role="form-title" data-form="income" data-create-title="Add Income"
                              data-edit-title="Update Income">
                              <%= incomeFormData && incomeFormData.transactionId ? 'Update Income' : 'Add Income' %>
                            </h2>
                            <button type="button"
                              class="btn ghost <%= incomeFormData && incomeFormData.transactionId ? '' : 'hidden' %>"
                              data-role="cancel-edit" data-form="income">
                              Cancel Edit
                            </button>
                          </div>
                          <% if (errors && errors.length && activeFormType==='income' ) { %>
                            <ul class="alert">
                              <% errors.forEach(function(error){ %>
                                <li>
                                  <%= error.msg %>
                                </li>
                                <% }) %>
                            </ul>
                            <% } %>
                              <form
                                action="<%= incomeFormData && incomeFormData.transactionId ? `/transactions/${incomeFormData.transactionId}` : '/transactions' %>"
                                method="POST" class="form" data-form="income"
                                data-mode="<%= incomeFormData && incomeFormData.transactionId ? 'edit' : 'create' %>"
                                data-transaction-id="<%= incomeFormData && incomeFormData.transactionId ? incomeFormData.transactionId : '' %>"
                                data-default-action="/transactions" data-default-date="<%= todayIso %>">
                                <input type="hidden" name="_method" data-field="method"
                                  value="<%= incomeFormData && incomeFormData.transactionId ? 'PUT' : '' %>" />
                                <input type="hidden" name="type" value="income" />

                                <label for="income-amount">Amount</label>
                                <input id="income-amount" name="amount" type="number" min="0" step="0.01"
                                  data-field="amount"
                                  value="<%= incomeFormData && incomeFormData.amount !== undefined ? incomeFormData.amount : '' %>"
                                  required />

                                <label for="income-date">Date</label>
                                <input id="income-date" name="date" type="date" data-field="date"
                                  value="<%= incomeFormData && incomeFormData.date ? incomeFormData.date : todayIso %>"
                                  required />

                                <label for="income-category">Source</label>
                                <input id="income-category" name="category" type="text" data-field="category"
                                  placeholder="e.g. Salary, Freelance"
                                  value="<%= incomeFormData && incomeFormData.category ? incomeFormData.category : '' %>"
                                  required />

                                <label for="income-description">Description</label>
                                <textarea id="income-description" name="description" rows="3" data-field="description"
                                  placeholder="Optional details"><%= incomeFormData && incomeFormData.description ? incomeFormData.description : '' %></textarea>

                                <button type="submit" class="btn primary" data-role="submit" data-form="income"
                                  data-create-label="Add Income" data-edit-label="Update Income">
                                  <%= incomeFormData && incomeFormData.transactionId ? 'Update Income' : 'Add Income' %>
                                </button>
                              </form>
                        </section>

                        <section class="card transaction-form" data-section="expense">
                          <div class="form-header">
                            <h2 data-role="form-title" data-form="expense" data-create-title="Add Expense"
                              data-edit-title="Update Expense">
                              <%= expenseFormData && expenseFormData.transactionId ? 'Update Expense' : 'Add Expense' %>
                            </h2>
                            <button type="button"
                              class="btn ghost <%= expenseFormData && expenseFormData.transactionId ? '' : 'hidden' %>"
                              data-role="cancel-edit" data-form="expense">
                              Cancel Edit
                            </button>
                          </div>
                          <% if (errors && errors.length && activeFormType==='expense' ) { %>
                            <ul class="alert">
                              <% errors.forEach(function(error){ %>
                                <li>
                                  <%= error.msg %>
                                </li>
                                <% }) %>
                            </ul>
                            <% } %>
                              <form
                                action="<%= expenseFormData && expenseFormData.transactionId ? `/transactions/${expenseFormData.transactionId}` : '/transactions' %>"
                                method="POST" class="form" data-form="expense"
                                data-mode="<%= expenseFormData && expenseFormData.transactionId ? 'edit' : 'create' %>"
                                data-transaction-id="<%= expenseFormData && expenseFormData.transactionId ? expenseFormData.transactionId : '' %>"
                                data-default-action="/transactions" data-default-date="<%= todayIso %>">
                                <input type="hidden" name="_method" data-field="method"
                                  value="<%= expenseFormData && expenseFormData.transactionId ? 'PUT' : '' %>" />
                                <input type="hidden" name="type" value="expense" />

                                <label for="expense-amount">Amount</label>
                                <input id="expense-amount" name="amount" type="number" min="0" step="0.01"
                                  data-field="amount"
                                  value="<%= expenseFormData && expenseFormData.amount !== undefined ? expenseFormData.amount : '' %>"
                                  required />

                                <label for="expense-date">Date</label>
                                <input id="expense-date" name="date" type="date" data-field="date"
                                  value="<%= expenseFormData && expenseFormData.date ? expenseFormData.date : todayIso %>"
                                  required />

                                <label for="expense-category">Category</label>
                                <input id="expense-category" name="category" type="text" data-field="category"
                                  placeholder="e.g. Groceries, Rent"
                                  value="<%= expenseFormData && expenseFormData.category ? expenseFormData.category : '' %>"
                                  required />

                                <label for="expense-description">Description</label>
                                <textarea id="expense-description" name="description" rows="3" data-field="description"
                                  placeholder="Optional details"><%= expenseFormData && expenseFormData.description ? expenseFormData.description : '' %></textarea>

                                <button type="submit" class="btn primary" data-role="submit" data-form="expense"
                                  data-create-label="Add Expense" data-edit-label="Update Expense">
                                  <%= expenseFormData && expenseFormData.transactionId ? 'Update Expense'
                                    : 'Add Expense' %>
                                </button>
                              </form>
                        </section>

                        <section class="card transaction-table">
                          <div class="card-header">
                            <h2>Transaction History</h2>
                            <% if (transactions.length> 0) { %>
                              <button type="button" class="btn danger" id="delete-all-btn" style="font-size: 13px;">
                                Delete All
                              </button>
                              <% } %>
                          </div>
                          <% if (!transactions.length) { %>
                            <p class="empty-state">No transactions yet. Add your first one!</p>
                            <% } else { %>
                              <div class="table-wrapper">
                                <table>
                                  <thead>
                                    <tr>
                                      <th>Date</th>
                                      <th>Type</th>
                                      <th>Category</th>
                                      <th>Description</th>
                                      <th class="numeric">Amount (Rs)</th>
                                      <th>Actions</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    <% transactions.forEach(function(transaction){ %>
                                      <tr data-id="<%= transaction._id %>">
                                        <td>
                                          <%= new Date(transaction.date).toISOString().slice(0, 10) %>
                                        </td>
                                        <td class="capitalize <%= transaction.type %>">
                                          <%= transaction.type %>
                                        </td>
                                        <td>
                                          <%= transaction.category %>
                                        </td>
                                        <td>
                                          <%= transaction.description || '-' %>
                                        </td>
                                        <td class="numeric">
                                          <%= Number(transaction.amount || 0).toFixed(2) %>
                                        </td>
                                        <td>
                                          <div class="table-actions">
                                            <button type="button" class="btn ghost edit-transaction"
                                              data-id="<%= transaction._id %>"
                                              data-amount="<%= Number(transaction.amount || 0).toFixed(2) %>"
                                              data-date="<%= new Date(transaction.date).toISOString().slice(0, 10) %>"
                                              data-type="<%= transaction.type %>"
                                              data-category="<%= transaction.category %>"
                                              data-description="<%= transaction.description || '' %>">
                                              Edit
                                            </button>
                                            <form action="/transactions/<%= transaction._id %>?_method=DELETE"
                                              method="POST">
                                              <input type="hidden" name="_method" value="DELETE" />
                                              <button type="submit" class="btn danger"
                                                onclick="return confirm('Delete this transaction?');">
                                                Delete
                                              </button>
                                            </form>
                                          </div>
                                        </td>
                                      </tr>
                                      <% }) %>
                                  </tbody>
                                </table>
                              </div>
                              <nav class="pagination">
                                <% if (pagination.hasPrevPage) { %>
                                  <a class="btn ghost"
                                    href="/transactions?page=<%= pagination.currentPage - 1 %>">Previous</a>
                                  <% } else { %>
                                    <span class="btn ghost disabled">Previous</span>
                                    <% } %>

                                      <span class="page-indicator">Page <%= pagination.currentPage %> of <%=
                                            pagination.totalPages %></span>

                                      <% if (pagination.hasNextPage) { %>
                                        <a class="btn ghost"
                                          href="/transactions?page=<%= pagination.currentPage + 1 %>">Next</a>
                                        <% } else { %>
                                          <span class="btn ghost disabled">Next</span>
                                          <% } %>
                              </nav>
                              <% } %>
                        </section>
                      </main>
                    </div>
                  </main>
                  </div>

                  <!-- Delete All Transactions Modal -->
                  <div class="modal" id="delete-all-modal">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h3>‚ö†Ô∏è Delete All Transactions</h3>
                        <button type="button" class="modal-close" id="modal-close">&times;</button>
                      </div>
                      <div class="modal-body">
                        <p style="margin-bottom: 16px; color: var(--danger);">
                          <strong>Warning:</strong> This action cannot be undone. All your transactions will be
                          permanently deleted.
                        </p>
                        <form id="delete-all-form">
                          <label for="confirm-password" style="display: block; margin-bottom: 8px; font-weight: 600;">
                            Enter your password to confirm:
                          </label>
                          <div class="password-field" style="margin-bottom: 16px;">
                            <input type="password" id="confirm-password" name="password" required
                              style="width: 100%; padding: 12px; border: 1.5px solid var(--border); border-radius: 8px; font-size: 14px;"
                              placeholder="Your password" />
                            <button type="button" class="password-toggle" onclick="toggleModalPassword()"
                              aria-label="Show password">
                              <span class="show-icon">üëÅÔ∏è</span>
                              <span class="hide-icon" style="display: none;">üôà</span>
                            </button>
                          </div>
                          <div id="delete-error"
                            style="display: none; color: var(--danger); margin-bottom: 12px; font-size: 14px;"></div>
                          <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button type="button" class="btn ghost" id="cancel-delete">Cancel</button>
                            <button type="submit" class="btn danger" id="confirm-delete">Delete All</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>

                  <script id="dashboard-analytics-data"
                    type="application/json"><%- JSON.stringify(analytics || null) %></script>
                  <script src="/js/ui.js"></script>
                  <script src="/js/dashboard.js"></script>
                  <script>
                    // Dashboard sidebar toggle
                    const sidebar = document.getElementById('sidebar');
                    const sidebarOverlay = document.getElementById('sidebar-overlay');
                    const mobileToggle = document.getElementById('mobile-toggle');
                    const sidebarToggle = document.getElementById('sidebar-toggle');

                    // Desktop sidebar minimize/maximize
                    if (sidebarToggle) {
                      // Load saved state
                      const sidebarMinimized = localStorage.getItem('sidebar-minimized') === 'true';
                      if (sidebarMinimized) {
                        sidebar.classList.add('minimized');
                      }

                      sidebarToggle.addEventListener('click', function () {
                        sidebar.classList.toggle('minimized');
                        localStorage.setItem('sidebar-minimized', sidebar.classList.contains('minimized'));
                      });
                    }

                    // Mobile sidebar toggle
                    if (mobileToggle) {
                      mobileToggle.addEventListener('click', function () {
                        sidebar.classList.toggle('is-open');
                        sidebarOverlay.classList.toggle('is-open');
                      });
                    }

                    if (sidebarOverlay) {
                      sidebarOverlay.addEventListener('click', function () {
                        sidebar.classList.remove('is-open');
                        sidebarOverlay.classList.remove('is-open');
                      });
                    }

                    // Delete All Transactions functionality
                    const deleteAllBtn = document.getElementById('delete-all-btn');
                    const deleteAllModal = document.getElementById('delete-all-modal');
                    const modalClose = document.getElementById('modal-close');
                    const cancelDelete = document.getElementById('cancel-delete');
                    const deleteAllForm = document.getElementById('delete-all-form');
                    const deleteError = document.getElementById('delete-error');
                    const confirmPasswordInput = document.getElementById('confirm-password');

                    if (deleteAllBtn) {
                      deleteAllBtn.addEventListener('click', function () {
                        deleteAllModal.style.display = 'flex';
                        deleteError.style.display = 'none';
                        confirmPasswordInput.value = '';
                        setTimeout(() => confirmPasswordInput.focus(), 100);
                      });
                    }

                    function closeModal() {
                      deleteAllModal.style.display = 'none';
                      deleteError.style.display = 'none';
                      confirmPasswordInput.value = '';
                    }

                    if (modalClose) {
                      modalClose.addEventListener('click', closeModal);
                    }

                    if (cancelDelete) {
                      cancelDelete.addEventListener('click', closeModal);
                    }

                    if (deleteAllModal) {
                      deleteAllModal.addEventListener('click', function (e) {
                        if (e.target === deleteAllModal) {
                          closeModal();
                        }
                      });
                    }

                    if (deleteAllForm) {
                      deleteAllForm.addEventListener('submit', async function (e) {
                        e.preventDefault();

                        const password = confirmPasswordInput.value;
                        const confirmDeleteBtn = document.getElementById('confirm-delete');

                        if (!password) {
                          deleteError.textContent = 'Password is required.';
                          deleteError.style.display = 'block';
                          return;
                        }

                        // Disable button during request
                        confirmDeleteBtn.disabled = true;
                        confirmDeleteBtn.textContent = 'Deleting...';
                        deleteError.style.display = 'none';

                        try {
                          const response = await fetch('/transactions/delete-all', {
                            method: 'POST',
                            headers: {
                              'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ password }),
                          });

                          const data = await response.json();

                          if (response.ok && data.success) {
                            alert(data.message);
                            window.location.reload();
                          } else {
                            deleteError.textContent = data.message || 'Failed to delete transactions.';
                            deleteError.style.display = 'block';
                            confirmDeleteBtn.disabled = false;
                            confirmDeleteBtn.textContent = 'Delete All';
                          }
                        } catch (error) {
                          deleteError.textContent = 'An error occurred. Please try again.';
                          deleteError.style.display = 'block';
                          confirmDeleteBtn.disabled = false;
                          confirmDeleteBtn.textContent = 'Delete All';
                        }
                      });
                    }

                    // Toggle password visibility for modal
                    function toggleModalPassword() {
                      const input = document.getElementById('confirm-password');
                      const button = input.nextElementSibling;
                      const showIcon = button.querySelector('.show-icon');
                      const hideIcon = button.querySelector('.hide-icon');

                      if (input.type === 'password') {
                        input.type = 'text';
                        showIcon.style.display = 'none';
                        hideIcon.style.display = 'inline';
                      } else {
                        input.type = 'password';
                        showIcon.style.display = 'inline';
                        hideIcon.style.display = 'none';
                      }
                    }
                  </script>
</body>

</html>